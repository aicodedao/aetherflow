# 90 — CLI Reference 

CLI entry point (ships with `aetherflow-core`):
- `aetherflow = aetherflow.core.cli:main` (defined in `packages/aetherflow-core/pyproject.toml`)

Implementation source:
- `packages/aetherflow-core/src/aetherflow/core/cli.py`

---

# `aetherflow` (core)

## Synopsis

```bash
aetherflow <command> [args...]
aetherflow --help
aetherflow <command> --help
````

Commands implemented in this repo snapshot:

* `run`
* `validate`
* `doctor`
* `explain`
* `bundle sync`
* `bundle status`

---

## `aetherflow run <flow_yaml>`

Run a flow YAML once.

```bash
aetherflow run path/to/flow.yaml
```

### Args

* `flow_yaml` (positional): path to flow YAML

### Options

* `--run-id <id>`: override run id (default: autogenerated inside runner if omitted)
* `--flow-job <job_id>`: run only one job (by `job.id`)
* `--bundle-manifest <path>`: optional bundle manifest; sync assets before run
* `--allow-stale-bundle`: if bundle sync fails, run with last active bundle (if present)

### Notes

* This command calls `aetherflow.core.runner.run_flow(...)`.
* Exceptions are not caught in the CLI layer → a crash/exception will terminate the process with a non-zero exit code (Python default).

---

## `aetherflow validate <flow_yaml>`

Validate a flow YAML (schema + semantic validation).

```bash
aetherflow validate path/to/flow.yaml
```

### Args

* `flow_yaml` (positional): path to flow YAML

### Options

* `--bundle-manifest <path>`: optional bundle manifest; sync before validation
* `--allow-stale-bundle`: if bundle sync fails, continue using last active bundle
* `--json`: output machine-readable JSON report

### Output behavior

* If `--json`:

    * prints a JSON object (includes `ok`, `flow_yaml`, plus `errors`/`warnings`)
* Else:

    * prints `OK: ...` or `INVALID: ...`
    * prints each error line as: `- <loc>: <code> - <msg>`
    * prints each warning line as: `! <loc>: <code> - <msg>`

### Exit codes

* `0` if validation OK
* `2` if validation fails

---

## `aetherflow doctor <flow_yaml>`

Doctor checks (env/profile sanity).

```bash
aetherflow doctor path/to/flow.yaml
```

### Args

* `flow_yaml` (positional): path to flow YAML

### Options

* `--bundle-manifest <path>`: optional bundle manifest; sync before checks
* `--allow-stale-bundle`: if bundle sync fails, continue using last active bundle
* `--json`: output machine-readable JSON report

### Output behavior (non-JSON)

* On success: `OK: <flow_yaml>`
* On failure: `FAIL: <flow_yaml>`
* Missing env items are printed as:

    * `- resource=<name> profile=<profile> <section>.<field> needs env <env_key>`
* Warnings are printed as:

    * `! <loc>: <code> - <msg>`

### Exit codes

* `0` if doctor OK
* `2` if doctor fails

---

## `aetherflow explain <flow_yaml>`

Explain profile → env mappings (attribution + decode).

```bash
aetherflow explain path/to/flow.yaml
```

### Args

* `flow_yaml` (positional): path to flow YAML

### Options

* `--bundle-manifest <path>`: optional bundle manifest; sync before explain
* `--allow-stale-bundle`: if bundle sync fails, continue using last active bundle
* `--json`: output machine-readable JSON report

### Output behavior (non-JSON)

Prints:

* `Flow: <flow_yaml>`
* For each resource:

    * `Resource: <name> (<kind>/<driver>) profile=<profile>`
    * If `decode` exists, prints it as JSON on one line

### Exit codes

* `0` (always, unless an uncaught exception occurs)

---

# `aetherflow bundle ...`

Bundle ops are implemented as a nested command group:

* `aetherflow bundle sync`
* `aetherflow bundle status`

## `aetherflow bundle sync --bundle-manifest <bundle.yaml>`

Sync a bundle manifest into the local active directory.

```bash
aetherflow bundle sync --bundle-manifest path/to/bundle.yaml
```

### Required

* `--bundle-manifest <path>`: path to bundle manifest YAML

### Options

* `--work-root <path>`: override work root (defaults to `AETHERFLOW_WORK_ROOT` or settings)
* `--allow-stale-bundle`: if sync fails, keep using last active bundle (if present)
* `--json`: output machine-readable JSON
* `--print-local-root`: print the synced local root directory path (only in non-JSON mode)

### Output (JSON)

Returns JSON with:

* `manifest`
* `local_root`
* `active_dir`
* `cache_dir`
* `fingerprints_dir`
* `fingerprint`
* `changed`
* `fetched_files`

### Exit codes

* `0` on success (sync either changed or unchanged)

---

## `aetherflow bundle status --bundle-manifest <bundle.yaml>`

Show local bundle status (no remote fetch).

```bash
aetherflow bundle status --bundle-manifest path/to/bundle.yaml
```

### Required

* `--bundle-manifest <path>`

### Options

* `--work-root <path>`
* `--json`

### Output (non-JSON)

Prints:

* `bundle_id=... fingerprint=... has_active=yes|no`
* and the three directories:

    * `active_dir=...`
    * `cache_dir=...`
    * `fingerprints_dir=...`

### Exit codes

* `0` on success

---

# Exit Codes (Practical)

Based on current CLI implementation (`cli.py`):

* `0`: success
* `2`: validate/doctor failure OR argparse usage error (argparse typically exits 2)
* `non-zero (usually 1)`: uncaught exception / crash in command execution

If you need stricter exit code semantics for ops, that belongs in CLI hardening (catch exceptions and map them), not in user flows.
