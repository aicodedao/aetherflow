name: Publish to PyPI (after release workflow)

on:
  workflow_run:
    workflows:
      - "Auto Release (Final) - master -> release + tags"   # change to your exact workflow name
    types: [completed]

permissions:
  id-token: write
  contents: read

concurrency:
  group: publish-pypi
  cancel-in-progress: false

jobs:
  publish_pypi:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo + tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Pick newest non-rc tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags origin

          TAG=$(git for-each-ref --sort=-creatordate --format='%(refname:short)' refs/tags \
            | grep -E '.+-v[0-9]+\.[0-9]+\.[0-9]+$' \
            | head -n 1)

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          PKG=${TAG%%-v*}
          echo "pkg=$PKG" >> $GITHUB_OUTPUT
          echo "pkg_dir=packages/$PKG" >> $GITHUB_OUTPUT

      - name: Checkout exact tag
        shell: bash
        run: |
          git checkout "refs/tags/${{ steps.meta.outputs.tag }}"
          git status -sb

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build dist
        shell: bash
        run: |
          python -m pip install -U pip build
          cd "${{ steps.meta.outputs.pkg_dir }}"
          python -m build

      - name: Publish to PyPI (OIDC)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ${{ steps.meta.outputs.pkg_dir }}/dist
