name: Publish to PyPI (tag)

on:
  push:
    tags:
      - "*-v*"

permissions:
  id-token: write
  contents: read

jobs:
  publish_pypi:
    # skip rc tags
    if: "!contains(github.ref_name, 'rc')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Parse package from tag
        id: meta
        shell: bash
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          PKG=${TAG%%-v*}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "pkg=$PKG" >> $GITHUB_OUTPUT
          echo "pkg_dir=packages/$PKG" >> $GITHUB_OUTPUT

      - name: Build dist
        shell: bash
        run: |
          python -m pip install -U pip build
          cd "${{ steps.meta.outputs.pkg_dir }}"
          python -m build

      - name: Publish to PyPI (OIDC)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ${{ steps.meta.outputs.pkg_dir }}/dist
