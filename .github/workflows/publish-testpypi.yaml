name: Publish RC to TestPyPI
run-name: "publish-testpypi: ${{ github.ref_name || inputs.tag }}"

on:
  push:
    tags:
      - "*-v*rc*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Exact tag to publish to TestPyPI (e.g. aetherflow-v0.0.1rc1)"
        required: true
        type: string

permissions:
  contents: read

concurrency:
  group: publish-testpypi-${{ github.ref_name || inputs.tag }}
  cancel-in-progress: false

jobs:
  publish:
    name: "TestPyPI: ${{ github.ref_name || inputs.tag }}"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (with tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Resolve tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Publishing tag: $TAG"

      - name: Checkout exact tag
        run: |
          git checkout "refs/tags/${{ steps.tag.outputs.tag }}"
          git status -sb

      - name: Parse package name from tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          PKG="${TAG%%-v*}"
          PKG_DIR="packages/$PKG"

          if [ ! -f "$PKG_DIR/pyproject.toml" ]; then
            echo "ERROR: $PKG_DIR does not contain pyproject.toml"
            exit 1
          fi

          echo "pkg=$PKG" >> "$GITHUB_OUTPUT"
          echo "pkg_dir=$PKG_DIR" >> "$GITHUB_OUTPUT"
          echo "Detected package: $PKG"
          echo "Package dir: $PKG_DIR"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build distribution
        working-directory: ${{ steps.meta.outputs.pkg_dir }}
        run: |
          python -m pip install -U pip build
          python -m build
          ls -la dist

      - name: Publish to PyPI (API Token)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: ${{ steps.meta.outputs.pkg_dir }}/dist
          skip-existing: false

